<div class="vscode-container">
  <!-- Title Bar -->
  <div class="titlebar">
    <div class="window-controls">
      <div class="window-dot red"></div>
      <div class="window-dot yellow"></div>
      <div class="window-dot green"></div>
    </div>
    <% if @is_running %>
      <%= form_with url: cancel_check_path, method: :post, local: true, data: { turbo: false, confirm: "å®Ÿè¡Œä¸­ã®ãƒ†ã‚¹ãƒˆã‚’ä¸­æ­¢ã—ã¾ã™ã‹ï¼Ÿ" }, class: "search-bar", style: "display: flex; align-items: center; gap: 8px;" do |f| %>
        <div style="flex: 1; position: relative;">
          <input type="text" value="ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..." readonly style="width: 100%;">
        </div>
        <%= button_tag type: 'submit', style: "background: none; border: none; color: #f48771; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; transition: color 0.1s;", onmouseover: "this.style.color='#ff5555'", onmouseout: "this.style.color='#f48771'" do %>
          â– 
        <% end %>
      <% end %>
    <% else %>
      <%= form_with url: checks_path, method: :post, local: true, data: { turbo: false }, class: "search-bar search-form-result", style: "display: flex; align-items: center; gap: 8px;" do |f| %>
        <div style="flex: 1; position: relative;" class="search-input-wrapper">
          <%= text_field_tag :target_url, "", placeholder: "ProtospaceæŒ™å‹•ç¢ºèªãƒã‚§ãƒƒã‚«ãƒ¼ - ãƒã‚§ãƒƒã‚¯å®Œäº†", class: "search-input-field", style: "width: 100%;" %>
        </div>
        <%= button_tag type: 'submit', style: "background: none; border: none; color: #89d185; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; transition: color 0.1s;", onmouseover: "this.style.color='#55ff55'", onmouseout: "this.style.color='#89d185'" do %>
          â–¶
        <% end %>
      <% end %>
    <% end %>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Activity Bar -->
    <div class="activity-bar">
      <div class="activity-icon active">
        <span>ğŸ“</span>
      </div>
      <div class="activity-icon">
        <span>ğŸ”</span>
      </div>
      <div class="activity-icon">
        <span style="font-size: 18px;">â‡</span>
      </div>
      <div class="activity-icon">
        <span>â–¶</span>
      </div>
      <div class="activity-icon">
        <span>âš™</span>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-resize-handle"></div>
      <div class="sidebar-header">
        ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼
      </div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">
          <span class="chevron">â–¼</span>
          <span>RESULTS</span>
        </div>
        <div class="sidebar-item" data-view="readme">
          <span class="file-icon">ğŸ“„</span>
          <span>README</span>
        </div>
        <div class="sidebar-item selected" data-view="results">
          <span class="file-icon">ğŸ“„</span>
          <span>check_results.json</span>
        </div>
      </div>
      <div class="sidebar-section" data-screenshot-section="true">
        <div class="sidebar-section-title">
          <span class="chevron">â–¼</span>
          <span>SCREENSHOTS</span>
        </div>
        <% if @screenshots && @screenshots.any? %>
          <% @screenshots.each do |screenshot| %>
            <div class="sidebar-item" data-view="screenshot" data-screenshot-path="<%= screenshot[:path] %>" data-screenshot-name="<%= screenshot[:name] %>">
              <span class="file-icon">ğŸ–¼ï¸</span>
              <span><%= screenshot[:name] %></span>
            </div>
          <% end %>
        <% end %>
      </div>
      <div class="sidebar-section" data-failure-screenshot-section="true">
        <div class="sidebar-section-title">
          <span class="chevron">â–¼</span>
          <span>FAILURE_SCREENSHOTS</span>
        </div>
        <% if @failure_screenshots && @failure_screenshots.any? %>
          <% @failure_screenshots.each do |screenshot| %>
            <div class="sidebar-item" data-view="failure-screenshot" data-screenshot-path="<%= screenshot[:path] %>" data-screenshot-name="<%= screenshot[:name] %>">
              <span class="file-icon">âš ï¸</span>
              <span><%= screenshot[:name] %></span>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- Editor Area -->
    <div class="editor-container">
      <div class="tab-bar">
        <div class="tab active">
          <span>ğŸ“„</span>
          <span>check_results.json</span>
        </div>
      </div>
      <div class="editor-content">
        <% if @status == 'running' %>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="spinner"></div>
            <h1 style="margin: 0;">ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...</h1>
          </div>
          <div class="subtitle">ä¸‹ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§é€²æ—ã‚’ç¢ºèªã§ãã¾ã™ã€‚åœæ­¢ã™ã‚‹å ´åˆã¯ä¸Šéƒ¨ã®åœæ­¢ãƒœã‚¿ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</div>
        <% else %>
          <h1>ãƒã‚§ãƒƒã‚¯çµæœ<% if @status == 'cancelled' %> <span style="color: #dcdcaa; font-size: 16px;">(ä¸­æ­¢ã•ã‚Œã¾ã—ãŸ)</span><% end %></h1>

          <% if @results && @results.any? %>
            <% pass_count = @results.count { |r| r[:status] == 'PASS' } %>
            <% fail_count = @results.count { |r| r[:status] == 'FAIL' } %>
            <% error_count = @results.count { |r| r[:status] == 'ERROR' } %>

            <div class="summary-box">
              <strong>ã‚µãƒãƒªãƒ¼:</strong>
              åˆæ ¼: <%= pass_count %> /
              ä¸åˆæ ¼: <%= fail_count %> /
              ã‚¨ãƒ©ãƒ¼: <%= error_count %> /
              åˆè¨ˆ: <%= @results.count %>
            </div>

            <% if @registered_users && @registered_users.any? %>
              <div data-registered-users style="margin-top: 20px; margin-bottom: 30px; padding: 20px; background-color: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px;">
                <h2 style="color: #4ec9b0; font-size: 18px; margin-bottom: 15px;">ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
                <% @registered_users.each_with_index do |user, index| %>
                  <div style="margin-bottom: 15px; padding: 12px; background-color: #252526; border-left: 3px solid #007acc; border-radius: 2px;">
                    <div style="color: #9cdcfe; font-weight: bold; margin-bottom: 5px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ <%= index + 1 %></div>
                    <div style="color: #ce9178; margin-bottom: 3px;">Email: <%= user[:email] %></div>
                    <div style="color: #ce9178;">Password: <%= user[:password] %></div>
                  </div>
                <% end %>
              </div>
            <% end %>

            <% @results.each do |result| %>
              <% status_class = result[:status] == 'PASS' ? 'pass' : (result[:status] == 'FAIL' ? 'fail' : 'error') %>
              <div class="result-item <%= status_class %>">
                <div class="result-header">
                  <div class="result-title">
                    <% if result[:status] == 'PASS' %>
                      <span class="text-success">âœ“</span>
                    <% elsif result[:status] == 'FAIL' %>
                      <span class="text-danger">âœ—</span>
                    <% else %>
                      <span class="text-warning">!</span>
                    <% end %>
                    <span><%= result[:check_number] %>: <%= result[:description] %></span>
                  </div>
                  <span class="badge badge-<%= result[:status] == 'PASS' ? 'success' : (result[:status] == 'FAIL' ? 'danger' : 'warning') %>">
                    <%= result[:status] %>
                  </span>
                </div>
                <% if result[:note].present? %>
                  <div class="text-muted"><strong>è£œè¶³:</strong> <%= result[:note] %></div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="text-muted">ãƒã‚§ãƒƒã‚¯çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>
          <% end %>
        <% end %>
      </div>

      <!-- Bottom Panel (Terminal) -->
      <div class="panel">
        <div class="panel-resize-handle"></div>
        <div class="panel-header">
          <div class="panel-tab">å•é¡Œ</div>
          <div class="panel-tab">å‡ºåŠ›</div>
          <div class="panel-tab">ãƒ‡ãƒãƒƒã‚° ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</div>
          <div class="panel-tab active">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</div>
          <div class="panel-tab">ãƒãƒ¼ãƒˆ</div>
          <div class="panel-controls">
            <span class="panel-control panel-toggle">âŒ„</span>
          </div>
        </div>
        <div class="panel-content" id="terminal-logs">
          <% if @logs && @logs.any? %>
            <% @logs.each do |log| %>
              <% message = log.is_a?(Hash) ? log[:message] : log %>
              <% log_type = log.is_a?(Hash) ? log[:type] : :info %>
              <div class="terminal-line" data-type="<%= log_type %>">
                <% if log_type == :success %>
                  <span style="color: #89d185;"><%= message %></span>
                <% elsif log_type == :fail %>
                  <span style="color: #f48771;"><%= message %></span>
                <% elsif log_type == :error %>
                  <span style="color: #dcdcaa;"><%= message %></span>
                <% elsif log_type == :progress %>
                  <div class="spinner"></div>
                  <span style="color: #858585;"><%= message %></span>
                <% else %>
                  <span style="color: #cccccc;"><%= message %></span>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="terminal-line">
              <div class="spinner"></div>
              <span style="color: #858585;">ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...</span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-item">â‡ main</div>
    <div class="status-item" id="status-pass">âœ“ <%= @results ? @results.count { |r| r[:status] == 'PASS' } : 0 %></div>
    <div class="status-item" id="status-fail">âš  <%= @results ? @results.count { |r| r[:status] != 'PASS' } : 0 %></div>
    <div class="status-bar-right">
      <div class="status-item">JSON</div>
      <div class="status-item">UTF-8</div>
      <div class="status-item">LF</div>
    </div>
  </div>
</div>

<% if @status == 'running' %>
<script>
  (function() {
    const sessionId = '<%= @session_id %>';
    const terminalLogs = document.getElementById('terminal-logs');
    const editorContent = document.querySelector('.editor-content');
    let lastLogCount = 0;
    let currentRegisteredUsers = [];

    function formatLog(logEntry) {
      const message = logEntry.message || logEntry;
      const type = logEntry.type || 'info';
      let color = '#cccccc';
      let spinner = '';

      switch(type) {
        case 'success':
          color = '#89d185';
          break;
        case 'fail':
          color = '#f48771';
          break;
        case 'error':
          color = '#dcdcaa';
          break;
        case 'progress':
          color = '#858585';
          spinner = '<div class="spinner"></div>';
          break;
        default:
          color = '#cccccc';
      }

      return `<div class="terminal-line" data-type="${type}">${spinner}<span style="color: ${color};">${message}</span></div>`;
    }

    function updateResults(results, status) {
      if (!results || results.length === 0) return;

      const passCount = results.filter(r => r.status === 'PASS').length;
      const failCount = results.filter(r => r.status !== 'PASS').length;

      document.getElementById('status-pass').textContent = 'âœ“ ' + passCount;
      document.getElementById('status-fail').textContent = 'âš  ' + failCount;

      // çµæœã‚’ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼éƒ¨åˆ†ã«è¡¨ç¤º
      const cancelledLabel = status === 'cancelled' ? ' <span style="color: #dcdcaa; font-size: 16px;">(ä¸­æ­¢ã•ã‚Œã¾ã—ãŸ)</span>' : '';
      let summaryHtml = `
        <h1>ãƒã‚§ãƒƒã‚¯çµæœ${cancelledLabel}</h1>
        <div class="summary-box">
          <strong>ã‚µãƒãƒªãƒ¼:</strong>
          åˆæ ¼: ${passCount} /
          ä¸åˆæ ¼: ${failCount} /
          åˆè¨ˆ: ${results.length}
        </div>
      `;

      results.forEach(result => {
        const statusClass = result.status === 'PASS' ? 'pass' : (result.status === 'FAIL' ? 'fail' : 'error');
        const icon = result.status === 'PASS' ? 'âœ“' : (result.status === 'FAIL' ? 'âœ—' : '!');
        const iconColor = result.status === 'PASS' ? 'text-success' : (result.status === 'FAIL' ? 'text-danger' : 'text-warning');
        const badgeClass = result.status === 'PASS' ? 'badge-success' : (result.status === 'FAIL' ? 'badge-danger' : 'badge-warning');

        summaryHtml += `
          <div class="result-item ${statusClass}">
            <div class="result-header">
              <div class="result-title">
                <span class="${iconColor}">${icon}</span>
                <span>${result.check_number}: ${result.description}</span>
              </div>
              <span class="badge ${badgeClass}">${result.status}</span>
            </div>
            ${result.note ? `<div class="text-muted"><strong>è£œè¶³:</strong> ${result.note}</div>` : ''}
          </div>
        `;
      });

      editorContent.innerHTML = summaryHtml;
    }

    function updateRegisteredUsers(registeredUsers) {
      if (!registeredUsers || registeredUsers.length === 0) return;

      // æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
      const existingUsersSection = editorContent.querySelector('[data-registered-users]');
      if (existingUsersSection) {
        existingUsersSection.remove();
      }

      let usersHtml = `
        <div data-registered-users style="margin-top: 20px; margin-bottom: 30px; padding: 20px; background-color: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px;">
          <h2 style="color: #4ec9b0; font-size: 18px; margin-bottom: 15px;">ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
      `;

      registeredUsers.forEach((user, index) => {
        usersHtml += `
          <div style="margin-bottom: 15px; padding: 12px; background-color: #252526; border-left: 3px solid #007acc; border-radius: 2px;">
            <div style="color: #9cdcfe; font-weight: bold; margin-bottom: 5px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${index + 1}</div>
            <div style="color: #ce9178; margin-bottom: 3px;">Email: ${user.email}</div>
            <div style="color: #ce9178;">Password: ${user.password}</div>
          </div>
        `;
      });

      usersHtml += `</div>`;

      // ã‚µãƒãƒªãƒ¼ãƒœãƒƒã‚¯ã‚¹ã®å¾Œã«æŒ¿å…¥ã€ãªã‘ã‚Œã°h1ã‚¿ã‚°ã®å¾Œã«æŒ¿å…¥
      const summaryBox = editorContent.querySelector('.summary-box');
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = usersHtml;

      if (summaryBox) {
        summaryBox.parentNode.insertBefore(tempDiv.firstElementChild, summaryBox.nextSibling);
      } else {
        const h1 = editorContent.querySelector('h1');
        if (h1) {
          h1.parentNode.insertBefore(tempDiv.firstElementChild, h1.nextSibling);
        } else {
          editorContent.appendChild(tempDiv.firstElementChild);
        }
      }
    }

    function updateScreenshots(screenshots) {
      if (!screenshots || screenshots.length === 0) return;

      // æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
      const screenshotSection = document.querySelector('[data-screenshot-section]');
      if (!screenshotSection) return;

      // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
      screenshots.forEach(screenshot => {
        // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const existingItem = screenshotSection.querySelector(`[data-screenshot-path="${screenshot.path}"]`);
        if (!existingItem) {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'sidebar-item';
          itemDiv.setAttribute('data-view', 'screenshot');
          itemDiv.setAttribute('data-screenshot-path', screenshot.path);
          itemDiv.setAttribute('data-screenshot-name', screenshot.name);
          itemDiv.innerHTML = `
            <span class="file-icon">ğŸ–¼ï¸</span>
            <span>${screenshot.name}</span>
          `;

          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
          itemDiv.addEventListener('click', function() {
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');

            const tabBar = document.querySelector('.tab-bar');
            tabBar.innerHTML = `
              <div class="tab active">
                <span>ğŸ–¼ï¸</span>
                <span>${screenshot.name}</span>
              </div>
            `;

            editorContent.innerHTML = `
              <div style="padding: 20px;">
                <h2 style="margin-bottom: 20px; color: #cccccc;">${screenshot.name}</h2>
                <div style="background: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px; padding: 10px; overflow: auto;">
                  <img src="${screenshot.path}" alt="${screenshot.name}" style="max-width: 100%; height: auto; display: block; border-radius: 4px;">
                </div>
              </div>
            `;
          });

          // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒcollapsedçŠ¶æ…‹ãªã‚‰ã€ã‚¢ã‚¤ãƒ†ãƒ ã‚’éè¡¨ç¤ºã«
          if (screenshotSection.classList.contains('collapsed')) {
            itemDiv.style.display = 'none';
          }

          screenshotSection.appendChild(itemDiv);
        }
      });
    }

    function updateFailureScreenshots(failureScreenshots) {
      if (!failureScreenshots || failureScreenshots.length === 0) return;

      // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
      const failureScreenshotSection = document.querySelector('[data-failure-screenshot-section]');
      if (!failureScreenshotSection) return;

      // ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
      failureScreenshots.forEach(screenshot => {
        // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const existingItem = failureScreenshotSection.querySelector(`[data-screenshot-path="${screenshot.path}"]`);
        if (!existingItem) {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'sidebar-item';
          itemDiv.setAttribute('data-view', 'failure-screenshot');
          itemDiv.setAttribute('data-screenshot-path', screenshot.path);
          itemDiv.setAttribute('data-screenshot-name', screenshot.name);
          itemDiv.innerHTML = `
            <span class="file-icon">âš ï¸</span>
            <span>${screenshot.name}</span>
          `;

          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
          itemDiv.addEventListener('click', function() {
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');

            const tabBar = document.querySelector('.tab-bar');
            tabBar.innerHTML = `
              <div class="tab active">
                <span>âš ï¸</span>
                <span>${screenshot.name}</span>
              </div>
            `;

            editorContent.innerHTML = `
              <div style="padding: 20px;">
                <h2 style="margin-bottom: 20px; color: #f48771;">${screenshot.name}</h2>
                <div style="background: #1e1e1e; border: 1px solid #d72828; border-radius: 4px; padding: 10px; overflow: auto;">
                  <img src="${screenshot.path}" alt="${screenshot.name}" style="max-width: 100%; height: auto; display: block; border-radius: 4px;">
                </div>
              </div>
            `;
          });

          // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒcollapsedçŠ¶æ…‹ãªã‚‰ã€ã‚¢ã‚¤ãƒ†ãƒ ã‚’éè¡¨ç¤ºã«
          if (failureScreenshotSection.classList.contains('collapsed')) {
            itemDiv.style.display = 'none';
          }

          failureScreenshotSection.appendChild(itemDiv);
        }
      });
    }

    function poll() {
      fetch(`/checks/${sessionId}/poll`)
        .then(response => response.json())
        .then(data => {
          // ãƒ­ã‚°ã‚’æ›´æ–°
          if (data.logs && data.logs.length > 0) {
            // å…¨ãƒ­ã‚°ã‚’å†æç”»ï¼ˆprogressãƒ­ã‚°ã®ä¸Šæ›¸ãã‚’åæ˜ ã™ã‚‹ãŸã‚ï¼‰
            terminalLogs.innerHTML = '';
            data.logs.forEach(log => {
              terminalLogs.innerHTML += formatLog(log);
            });
            lastLogCount = data.logs.length;

            // ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            terminalLogs.scrollTop = terminalLogs.scrollHeight;
          }

          // ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°ãƒ»ä¿å­˜
          if (data.registered_users && data.registered_users.length > 0) {
            currentRegisteredUsers = data.registered_users;
          }

          // å®Œäº†ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»ä¸­æ–­æ™‚ã®ã¿çµæœã‚’æ›´æ–°ã—ã¦è¡¨ç¤º
          if (data.status === 'completed' || data.status === 'error' || data.status === 'cancelled') {
            // çµæœã‚’æ›´æ–°
            if (data.results && data.results.length > 0) {
              updateResults(data.results, data.status);
            }

            // ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤º
            if (currentRegisteredUsers.length > 0) {
              updateRegisteredUsers(currentRegisteredUsers);
            }

            // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ›´æ–°
            if (data.screenshots && data.screenshots.length > 0) {
              updateScreenshots(data.screenshots);
            }

            // å¤±æ•—ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ›´æ–°
            if (data.failure_screenshots && data.failure_screenshots.length > 0) {
              updateFailureScreenshots(data.failure_screenshots);
            }

            console.log('Check completed with status:', data.status);
          } else {
            // å®Ÿè¡Œä¸­ã¯ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ç¶™ç¶š
            setTimeout(poll, 500); // 0.5ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
          }
        })
        .catch(error => {
          console.error('Polling error:', error);
          setTimeout(poll, 1000); // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯1ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤
        });
    }

    // åˆå›ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
    poll();
  })();
</script>
<% end %>

<script>
  // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
  document.addEventListener('DOMContentLoaded', function() {
    // URLå…¥åŠ›æ¬„ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆéœ‡ãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    const searchForm = document.querySelector('.search-form-result');
    if (searchForm) {
      searchForm.addEventListener('submit', function(e) {
        const inputField = this.querySelector('.search-input-field');
        const inputWrapper = this.querySelector('.search-input-wrapper');
        const value = inputField ? inputField.value.trim() : '';

        // ç©ºæ¬„ãƒã‚§ãƒƒã‚¯
        if (!value) {
          e.preventDefault();
          shakeInput(inputWrapper, inputField);
          return;
        }

        // URLå½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆhttp://ã¾ãŸã¯https://ã§å§‹ã¾ã‚‹ã‹ï¼‰
        if (!value.match(/^https?:\/\/.+/i)) {
          e.preventDefault();
          shakeInput(inputWrapper, inputField);
          return;
        }
      });
    }

    function shakeInput(wrapper, field) {
      // æ—¢å­˜ã®shakeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
      wrapper.classList.remove('shake');

      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰shakeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ãƒˆãƒªã‚¬ãƒ¼ï¼‰
      setTimeout(() => {
        wrapper.classList.add('shake');
      }, 10);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      setTimeout(() => {
        wrapper.classList.remove('shake');
      }, 510);

      // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      field.focus();
    }

    const sidebarItems = document.querySelectorAll('.sidebar-item');
    const editorContent = document.querySelector('.editor-content');
    const tabBar = document.querySelector('.tab-bar');

    // å…ƒã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã‚¿ãƒ–ã‚’ä¿å­˜
    const originalContent = editorContent.innerHTML;
    const originalTab = tabBar.innerHTML;

    // READMEã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    const readmeContent = `
      <h1 style="color: #4ec9b0; font-size: 28px; margin-bottom: 20px;">ğŸ” Protospace Checker</h1>

      <div style="margin-bottom: 30px;">
        <h2 style="color: #569cd6; font-size: 20px; margin-bottom: 12px;">æ¦‚è¦</h2>
        <p style="color: #cccccc; line-height: 1.8; margin-bottom: 16px;">
          Protospace Checkerã¯TECH CAMPèª²é¡Œã€ŒProtospaceã€ã®å®Ÿè£…è¦ä»¶ã‚’è‡ªå‹•çš„ã«æ¤œè¨¼ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚<br>
          Seleniumã‚’ä½¿ç”¨ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã‚’è‡ªå‹•åŒ–ã—ã€å„æ©Ÿèƒ½ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
        </p>
      </div>

      <div style="margin-bottom: 30px;">
        <h2 style="color: #569cd6; font-size: 20px; margin-bottom: 12px;">ä¸»ãªæ©Ÿèƒ½</h2>
        <ul style="color: #cccccc; line-height: 2; margin-left: 20px;">
          <li>âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®æ¤œè¨¼</li>
          <li>âœ… ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æŠ•ç¨¿ãƒ»ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½ã®æ¤œè¨¼</li>
          <li>âœ… ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ©Ÿèƒ½ã®æ¤œè¨¼</li>
          <li>âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã®æ¤œè¨¼</li>
          <li>ğŸ“¸ å„ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè‡ªå‹•å–å¾—</li>
          <li>ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®é€²æ—è¡¨ç¤º</li>
          <li>â¸ï¸ ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œã®é€”ä¸­åœæ­¢æ©Ÿèƒ½</li>
        </ul>
      </div>

      <div style="margin-bottom: 30px;">
        <h2 style="color: #569cd6; font-size: 20px; margin-bottom: 12px;">ä½¿ã„æ–¹</h2>
        <div style="background-color: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px; padding: 16px; margin-bottom: 16px;">
          <div style="color: #858585; font-size: 12px; margin-bottom: 8px;">STEP 1</div>
          <p style="color: #cccccc; line-height: 1.8;">
            ä¸Šéƒ¨ã®æ¤œç´¢ãƒãƒ¼ã«ã€ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®Protospaceã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
            <span style="color: #ce9178;">ä¾‹: https://protospace2020.herokuapp.com/</span>
          </p>
        </div>

        <div style="background-color: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px; padding: 16px; margin-bottom: 16px;">
          <div style="color: #858585; font-size: 12px; margin-bottom: 8px;">STEP 2</div>
          <p style="color: #cccccc; line-height: 1.8;">
            ç·‘è‰²ã®å†ç”Ÿãƒœã‚¿ãƒ³ <span style="color: #27c93f; font-weight: bold;">â–¶</span> ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™ã€‚
          </p>
        </div>

        <div style="background-color: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px; padding: 16px; margin-bottom: 16px;">
          <div style="color: #858585; font-size: 12px; margin-bottom: 8px;">STEP 3</div>
          <p style="color: #cccccc; line-height: 1.8;">
            ä¸‹éƒ¨ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§é€²æ—ã‚’ç¢ºèªã—ãªãŒã‚‰ã€çµæœã‚’å¾…ã¡ã¾ã™ã€‚<br>
            é€”ä¸­ã§åœæ­¢ã—ãŸã„å ´åˆã¯ã€èµ¤è‰²ã®åœæ­¢ãƒœã‚¿ãƒ³ <span style="color: #c93333; font-weight: bold;">â– </span> ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>

        <div style="background-color: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px; padding: 16px;">
          <div style="color: #858585; font-size: 12px; margin-bottom: 8px;">STEP 4</div>
          <p style="color: #cccccc; line-height: 1.8;">
            ãƒã‚§ãƒƒã‚¯å®Œäº†å¾Œã€çµæœãƒšãƒ¼ã‚¸ã§å„é …ç›®ã®åˆæ ¼/ä¸åˆæ ¼ã‚’ç¢ºèªã§ãã¾ã™ã€‚<br>
            ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®SCREENSHOTSã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã€å„ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚‚ç¢ºèªå¯èƒ½ã§ã™ã€‚
          </p>
        </div>
      </div>

      <div style="margin-bottom: 30px;">
        <h2 style="color: #569cd6; font-size: 20px; margin-bottom: 12px;">æ³¨æ„äº‹é …</h2>
        <div style="background-color: #3c2a1e; border-left: 3px solid #c9a000; padding: 16px; border-radius: 4px;">
          <p style="color: #dcdcaa; line-height: 1.8; margin-bottom: 8px;">
            âš ï¸ ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„
          </p>
          <p style="color: #dcdcaa; line-height: 1.8; margin-bottom: 8px;">
            âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒãƒªã‚»ãƒƒãƒˆå¯èƒ½ãªçŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„
          </p>
          <p style="color: #dcdcaa; line-height: 1.8;">
            âš ï¸ ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­ã¯å¯¾è±¡ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ“ä½œã—ãªã„ã§ãã ã•ã„
          </p>
        </div>
      </div>

      <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #3c3c3c;">
        <p style="color: #858585; font-size: 12px; text-align: center;">
          Protospace Checker v1.0 | Built with Ruby on Rails & Selenium
        </p>
      </div>
    `;

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹é–‰æ©Ÿèƒ½
    const sectionTitles = document.querySelectorAll('.sidebar-section-title');
    sectionTitles.forEach(title => {
      title.addEventListener('click', function() {
        const section = this.parentElement;
        const chevron = this.querySelector('.chevron');
        const items = Array.from(section.children).filter(child => child.classList.contains('sidebar-item'));

        // é–‹é–‰çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«
        const isCollapsed = section.classList.toggle('collapsed');

        if (isCollapsed) {
          chevron.textContent = 'â–¶';
          items.forEach(item => item.style.display = 'none');
        } else {
          chevron.textContent = 'â–¼';
          items.forEach(item => item.style.display = 'flex');
        }
      });

      // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«
      title.style.cursor = 'pointer';
    });

    sidebarItems.forEach(item => {
      item.addEventListener('click', function() {
        // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        sidebarItems.forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');

        const viewType = this.getAttribute('data-view');

        if (viewType === 'readme') {
          // ã‚¿ãƒ–ã‚’æ›´æ–°
          tabBar.innerHTML = `
            <div class="tab active">
              <span>ğŸ“„</span>
              <span>README</span>
            </div>
          `;

          // READMEã‚’è¡¨ç¤º
          editorContent.innerHTML = readmeContent;
        } else if (viewType === 'screenshot') {
          const screenshotPath = this.getAttribute('data-screenshot-path');
          const screenshotName = this.getAttribute('data-screenshot-name');

          // ã‚¿ãƒ–ã‚’æ›´æ–°
          tabBar.innerHTML = `
            <div class="tab active">
              <span>ğŸ–¼ï¸</span>
              <span>${screenshotName}</span>
            </div>
          `;

          // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’è¡¨ç¤º
          editorContent.innerHTML = `
            <div style="padding: 20px;">
              <h2 style="margin-bottom: 20px; color: #cccccc;">${screenshotName}</h2>
              <div style="background: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px; padding: 10px; overflow: auto;">
                <img src="${screenshotPath}" alt="${screenshotName}" style="max-width: 100%; height: auto; display: block; border-radius: 4px;">
              </div>
            </div>
          `;
        } else if (viewType === 'failure-screenshot') {
          const screenshotPath = this.getAttribute('data-screenshot-path');
          const screenshotName = this.getAttribute('data-screenshot-name');

          // ã‚¿ãƒ–ã‚’æ›´æ–°
          tabBar.innerHTML = `
            <div class="tab active">
              <span>âš ï¸</span>
              <span>${screenshotName}</span>
            </div>
          `;

          // å¤±æ•—ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’è¡¨ç¤ºï¼ˆèµ¤ã„ãƒœãƒ¼ãƒ€ãƒ¼ï¼‰
          editorContent.innerHTML = `
            <div style="padding: 20px;">
              <h2 style="margin-bottom: 20px; color: #f48771;">${screenshotName}</h2>
              <div style="background: #1e1e1e; border: 1px solid #d72828; border-radius: 4px; padding: 10px; overflow: auto;">
                <img src="${screenshotPath}" alt="${screenshotName}" style="max-width: 100%; height: auto; display: block; border-radius: 4px;">
              </div>
            </div>
          `;
        } else if (viewType === 'results') {
          // å…ƒã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã‚¿ãƒ–ã«æˆ»ã™
          tabBar.innerHTML = originalTab;
          editorContent.innerHTML = originalContent;
        }
      });
    });

    // ãƒ‘ãƒãƒ«ã®é–‹é–‰æ©Ÿèƒ½
    const panelToggle = document.querySelector('.panel-toggle');
    const panel = document.querySelector('.panel');

    if (panelToggle && panel) {
      let originalHeight = panel.offsetHeight;

      panelToggle.addEventListener('click', function() {
        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’è¦‹ã¦åˆ¤æ–­
        const isCurrentlyClosed = panelToggle.textContent === '^';

        if (isCurrentlyClosed) {
          // é–‹ã
          panel.style.height = originalHeight + 'px';
          panelToggle.textContent = 'âŒ„';
        } else {
          // ç•³ã‚€
          originalHeight = panel.offsetHeight;
          panel.style.height = '35px';
          panelToggle.textContent = '^';
        }
      });
    }
  });
</script>
