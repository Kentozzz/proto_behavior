<div class="vscode-container">
  <!-- Title Bar -->
  <div class="titlebar">
    <div class="window-controls">
      <div class="window-dot red"></div>
      <div class="window-dot yellow"></div>
      <div class="window-dot green"></div>
    </div>
    <div class="search-bar">
      <span class="search-icon">ğŸ”</span>
      <input type="text" placeholder="ãƒã‚§ãƒƒã‚¯çµæœ" readonly>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Activity Bar -->
    <div class="activity-bar">
      <div class="activity-icon active">
        <span>ğŸ“</span>
      </div>
      <div class="activity-icon">
        <span>ğŸ”</span>
      </div>
      <div class="activity-icon">
        <span style="font-size: 18px;">â‡</span>
      </div>
      <div class="activity-icon">
        <span>â–¶</span>
      </div>
      <div class="activity-icon">
        <span>âš™</span>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼
      </div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">
          <span class="chevron">â–¼</span>
          <span>RESULTS</span>
        </div>
        <div class="sidebar-item selected">
          <span class="file-icon">ğŸ“„</span>
          <span>check_results.json</span>
        </div>
        <div class="sidebar-item">
          <span class="file-icon">ğŸ“„</span>
          <span>summary.md</span>
        </div>
      </div>
    </div>

    <!-- Editor Area -->
    <div class="editor-container">
      <div class="tab-bar">
        <div class="tab active">
          <span>ğŸ“„</span>
          <span>check_results.json</span>
        </div>
      </div>
      <div class="editor-content">
        <% if @status == 'running' %>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="spinner"></div>
            <h1 style="margin: 0;">ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...</h1>
          </div>
          <div class="subtitle">ä¸‹ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§é€²æ—ã‚’ç¢ºèªã§ãã¾ã™</div>
          <div class="button-group" style="margin-top: 20px;">
            <%= button_to "ãƒ†ã‚¹ãƒˆã‚’ä¸­æ­¢", cancel_check_path, method: :post,
                style: "background: #c93333; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;",
                data: { confirm: "å®Ÿè¡Œä¸­ã®ãƒ†ã‚¹ãƒˆã‚’ä¸­æ­¢ã—ã¾ã™ã‹ï¼Ÿ" } %>
          </div>
        <% elsif @results && @results.any? %>
          <h1>ãƒã‚§ãƒƒã‚¯çµæœ</h1>

          <% pass_count = @results.count { |r| r[:status] == 'PASS' } %>
          <% fail_count = @results.count { |r| r[:status] == 'FAIL' } %>
          <% error_count = @results.count { |r| r[:status] == 'ERROR' } %>

          <div class="summary-box">
            <strong>ã‚µãƒãƒªãƒ¼:</strong>
            åˆæ ¼: <%= pass_count %> /
            ä¸åˆæ ¼: <%= fail_count %> /
            ã‚¨ãƒ©ãƒ¼: <%= error_count %> /
            åˆè¨ˆ: <%= @results.count %>
          </div>

          <% if @registered_users && @registered_users.any? %>
            <div data-registered-users style="margin-top: 20px; margin-bottom: 30px; padding: 20px; background-color: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px;">
              <h2 style="color: #4ec9b0; font-size: 18px; margin-bottom: 15px;">ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
              <% @registered_users.each_with_index do |user, index| %>
                <div style="margin-bottom: 15px; padding: 12px; background-color: #252526; border-left: 3px solid #007acc; border-radius: 2px;">
                  <div style="color: #9cdcfe; font-weight: bold; margin-bottom: 5px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ <%= index + 1 %></div>
                  <div style="color: #ce9178; margin-bottom: 3px;">Email: <%= user[:email] %></div>
                  <div style="color: #ce9178;">Password: <%= user[:password] %></div>
                </div>
              <% end %>
            </div>
          <% end %>

          <% @results.each do |result| %>
            <% status_class = result[:status] == 'PASS' ? 'pass' : (result[:status] == 'FAIL' ? 'fail' : 'error') %>
            <div class="result-item <%= status_class %>">
              <div class="result-header">
                <div class="result-title">
                  <% if result[:status] == 'PASS' %>
                    <span class="text-success">âœ“</span>
                  <% elsif result[:status] == 'FAIL' %>
                    <span class="text-danger">âœ—</span>
                  <% else %>
                    <span class="text-warning">!</span>
                  <% end %>
                  <span><%= result[:check_number] %>: <%= result[:description] %></span>
                </div>
                <span class="badge badge-<%= result[:status] == 'PASS' ? 'success' : (result[:status] == 'FAIL' ? 'danger' : 'warning') %>">
                  <%= result[:status] %>
                </span>
              </div>
              <% if result[:note].present? %>
                <div class="text-muted"><strong>è£œè¶³:</strong> <%= result[:note] %></div>
              <% end %>
            </div>
          <% end %>

          <div class="button-group">
            <%= link_to "æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ", new_check_path, class: "btn-primary" %>
            <%= link_to "ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹", checks_path, class: "btn-secondary" %>
          </div>
        <% else %>
          <h1>ãƒã‚§ãƒƒã‚¯çµæœ</h1>
          <div class="text-muted">ãƒã‚§ãƒƒã‚¯çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>

          <div class="button-group">
            <%= link_to "æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ", new_check_path, class: "btn-primary" %>
            <%= link_to "ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹", checks_path, class: "btn-secondary" %>
          </div>
        <% end %>
      </div>

      <!-- Bottom Panel (Terminal) -->
      <div class="panel">
        <div class="panel-resize-handle"></div>
        <div class="panel-header">
          <div class="panel-tab">å•é¡Œ</div>
          <div class="panel-tab active">å‡ºåŠ›</div>
          <div class="panel-tab">ãƒ‡ãƒãƒƒã‚° ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</div>
          <div class="panel-tab">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</div>
          <div class="panel-tab">ãƒãƒ¼ãƒˆ</div>
          <div class="panel-controls">
            <span class="panel-control">+</span>
            <span class="panel-control">âŒ„</span>
            <span class="panel-control">Ã—</span>
          </div>
        </div>
        <div class="panel-content" id="terminal-logs">
          <% if @logs && @logs.any? %>
            <% @logs.each do |log| %>
              <% message = log.is_a?(Hash) ? log[:message] : log %>
              <% log_type = log.is_a?(Hash) ? log[:type] : :info %>
              <div class="terminal-line" data-type="<%= log_type %>">
                <% if log_type == :success %>
                  <span style="color: #89d185;"><%= message %></span>
                <% elsif log_type == :fail %>
                  <span style="color: #f48771;"><%= message %></span>
                <% elsif log_type == :error %>
                  <span style="color: #dcdcaa;"><%= message %></span>
                <% elsif log_type == :progress %>
                  <div class="spinner"></div>
                  <span style="color: #858585;"><%= message %></span>
                <% else %>
                  <span style="color: #cccccc;"><%= message %></span>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="terminal-line">
              <div class="spinner"></div>
              <span style="color: #858585;">ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...</span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-item">â‡ main</div>
    <div class="status-item" id="status-pass">âœ“ <%= @results ? @results.count { |r| r[:status] == 'PASS' } : 0 %></div>
    <div class="status-item" id="status-fail">âš  <%= @results ? @results.count { |r| r[:status] != 'PASS' } : 0 %></div>
    <div class="status-bar-right">
      <div class="status-item">JSON</div>
      <div class="status-item">UTF-8</div>
      <div class="status-item">LF</div>
    </div>
  </div>
</div>

<% if @status == 'running' %>
<script>
  (function() {
    const sessionId = '<%= @session_id %>';
    const terminalLogs = document.getElementById('terminal-logs');
    const editorContent = document.querySelector('.editor-content');
    let lastLogCount = 0;
    let currentRegisteredUsers = [];

    function formatLog(logEntry) {
      const message = logEntry.message || logEntry;
      const type = logEntry.type || 'info';
      let color = '#cccccc';
      let spinner = '';

      switch(type) {
        case 'success':
          color = '#89d185';
          break;
        case 'fail':
          color = '#f48771';
          break;
        case 'error':
          color = '#dcdcaa';
          break;
        case 'progress':
          color = '#858585';
          spinner = '<div class="spinner"></div>';
          break;
        default:
          color = '#cccccc';
      }

      return `<div class="terminal-line" data-type="${type}">${spinner}<span style="color: ${color};">${message}</span></div>`;
    }

    function updateResults(results) {
      if (!results || results.length === 0) return;

      const passCount = results.filter(r => r.status === 'PASS').length;
      const failCount = results.filter(r => r.status !== 'PASS').length;

      document.getElementById('status-pass').textContent = 'âœ“ ' + passCount;
      document.getElementById('status-fail').textContent = 'âš  ' + failCount;

      // çµæœã‚’ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼éƒ¨åˆ†ã«è¡¨ç¤º
      let summaryHtml = `
        <h1>ãƒã‚§ãƒƒã‚¯çµæœ</h1>
        <div class="summary-box">
          <strong>ã‚µãƒãƒªãƒ¼:</strong>
          åˆæ ¼: ${passCount} /
          ä¸åˆæ ¼: ${failCount} /
          åˆè¨ˆ: ${results.length}
        </div>
      `;

      results.forEach(result => {
        const statusClass = result.status === 'PASS' ? 'pass' : (result.status === 'FAIL' ? 'fail' : 'error');
        const icon = result.status === 'PASS' ? 'âœ“' : (result.status === 'FAIL' ? 'âœ—' : '!');
        const iconColor = result.status === 'PASS' ? 'text-success' : (result.status === 'FAIL' ? 'text-danger' : 'text-warning');
        const badgeClass = result.status === 'PASS' ? 'badge-success' : (result.status === 'FAIL' ? 'badge-danger' : 'badge-warning');

        summaryHtml += `
          <div class="result-item ${statusClass}">
            <div class="result-header">
              <div class="result-title">
                <span class="${iconColor}">${icon}</span>
                <span>${result.check_number}: ${result.description}</span>
              </div>
              <span class="badge ${badgeClass}">${result.status}</span>
            </div>
            ${result.note ? `<div class="text-muted"><strong>è£œè¶³:</strong> ${result.note}</div>` : ''}
          </div>
        `;
      });

      summaryHtml += `
        <div class="button-group">
          <a href="/checks/new" class="btn-primary">æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ</a>
          <a href="/checks" class="btn-secondary">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
        </div>
      `;

      editorContent.innerHTML = summaryHtml;
    }

    function updateRegisteredUsers(registeredUsers) {
      if (!registeredUsers || registeredUsers.length === 0) return;

      // æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
      const existingUsersSection = editorContent.querySelector('[data-registered-users]');
      if (existingUsersSection) {
        existingUsersSection.remove();
      }

      let usersHtml = `
        <div data-registered-users style="margin-top: 20px; margin-bottom: 30px; padding: 20px; background-color: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px;">
          <h2 style="color: #4ec9b0; font-size: 18px; margin-bottom: 15px;">ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
      `;

      registeredUsers.forEach((user, index) => {
        usersHtml += `
          <div style="margin-bottom: 15px; padding: 12px; background-color: #252526; border-left: 3px solid #007acc; border-radius: 2px;">
            <div style="color: #9cdcfe; font-weight: bold; margin-bottom: 5px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${index + 1}</div>
            <div style="color: #ce9178; margin-bottom: 3px;">Email: ${user.email}</div>
            <div style="color: #ce9178;">Password: ${user.password}</div>
          </div>
        `;
      });

      usersHtml += `</div>`;

      // ã‚µãƒãƒªãƒ¼ãƒœãƒƒã‚¯ã‚¹ã®å¾Œã«æŒ¿å…¥ã€ãªã‘ã‚Œã°h1ã‚¿ã‚°ã®å¾Œã«æŒ¿å…¥
      const summaryBox = editorContent.querySelector('.summary-box');
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = usersHtml;

      if (summaryBox) {
        summaryBox.parentNode.insertBefore(tempDiv.firstElementChild, summaryBox.nextSibling);
      } else {
        const h1 = editorContent.querySelector('h1');
        if (h1) {
          h1.parentNode.insertBefore(tempDiv.firstElementChild, h1.nextSibling);
        } else {
          editorContent.appendChild(tempDiv.firstElementChild);
        }
      }
    }

    function poll() {
      fetch(`/checks/${sessionId}/poll`)
        .then(response => response.json())
        .then(data => {
          // ãƒ­ã‚°ã‚’æ›´æ–°
          if (data.logs && data.logs.length > 0) {
            // å…¨ãƒ­ã‚°ã‚’å†æç”»ï¼ˆprogressãƒ­ã‚°ã®ä¸Šæ›¸ãã‚’åæ˜ ã™ã‚‹ãŸã‚ï¼‰
            terminalLogs.innerHTML = '';
            data.logs.forEach(log => {
              terminalLogs.innerHTML += formatLog(log);
            });
            lastLogCount = data.logs.length;

            // ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            terminalLogs.scrollTop = terminalLogs.scrollHeight;
          }

          // ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°ãƒ»ä¿å­˜
          if (data.registered_users && data.registered_users.length > 0) {
            currentRegisteredUsers = data.registered_users;
          }

          // çµæœã‚’æ›´æ–°
          if (data.results && data.results.length > 0) {
            updateResults(data.results);
          }

          // ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤ºï¼ˆçµæœãŒã‚ã‚‹å ´åˆã‚‚ãªã„å ´åˆã‚‚ï¼‰
          if (currentRegisteredUsers.length > 0) {
            updateRegisteredUsers(currentRegisteredUsers);
          }

          // å®Œäº†ã—ãŸã‚‰ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢
          if (data.status === 'completed' || data.status === 'error') {
            console.log('Check completed');
          } else {
            setTimeout(poll, 500); // 0.5ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
          }
        })
        .catch(error => {
          console.error('Polling error:', error);
          setTimeout(poll, 1000); // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯1ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤
        });
    }

    // åˆå›ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
    poll();
  })();
</script>
<% end %>
